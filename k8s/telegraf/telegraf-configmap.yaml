apiVersion: v1
kind: ConfigMap
metadata:
  name: telegraf-config
  namespace: ibuki-mitarashi-bot
data:
  telegraf.conf: |-
    ########################################
    # Global Agent Configuration
    ########################################
    [agent]
      interval = "10s"
      round_interval = true
      metric_batch_size = 1000
      metric_buffer_limit = 10000
      collection_jitter = "0s"
      flush_interval = "10s"
      flush_jitter = "0s"
      precision = "1ns"

    ########################################
    # OUTPUTS
    ########################################
    [[outputs.influxdb_v2]]
      ## InfluxDB v2 details - configure via env vars in DaemonSet
      ## URL example: https://influxdb.skyia.jp
      urls = ["${INFLUX_URL}"]
      token = "${INFLUX_TOKEN}"
      organization = "${INFLUX_ORG}"
      bucket = "${INFLUX_BUCKET}"

    ########################################
    # INPUTS - system, cpu, mem, disk, processes
    ########################################
    [[inputs.cpu]]
      percpu = true
      totalcpu = true
      collect_cpu_time = false

    [[inputs.mem]]

    [[inputs.disk]]
      ignore_fs = ["tmpfs", "devtmpfs"]

    [[inputs.kernel]]

    [[inputs.processes]]

    [[inputs.net]]

    # kubernetes inputs - requires RBAC to list pods/nodes
    [[inputs.kubernetes]]
      url = ""
      response_timeout = "5s"
      tls_ca = ""

    # docker/container metrics (if node has docker socket)
    [[inputs.docker]]
      endpoint = "unix:///var/run/docker.sock"
      gather_services = false

    ########################################
    # LOGS - tail container logs produced by kubelet
    ########################################
    [[inputs.tail]]
      files = ["/var/log/containers/*.log"]
      from_beginning = false
      name_override = "k8s_container_logs"
      data_format = "json"
      json_time_key = "time"
      json_time_format = "RFC3339"
      # fallback to regex if logs are not pure json
      grok_patterns = ["%{TIMESTAMP_ISO8601:ts} %{GREEDYDATA:message}"]
      grok_names = ["timestamp","message"]

    ########################################
    # PROCESSOR/AGGREGATOR examples (optional)
    ########################################
    [[processors.rename]]
      [[processors.rename.replace]]
        field = "usage_guest"
        dest = "cpu_usage_guest"
